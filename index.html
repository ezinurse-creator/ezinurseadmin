<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ezinurse | Corporate Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --nav-bg: #111827; --accent: #2563eb; }
        body { background: #f9fafb; font-family: 'Inter', system-ui, sans-serif; overflow-x: hidden; }
        .sidebar { width: 280px; height: 100vh; background: var(--nav-bg); color: white; position: fixed; left: 0; top: 0; }
        .main { margin-left: 280px; padding: 40px; }
        .nav-link { color: #9ca3af; padding: 12px 25px; border-radius: 0; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { color: white; background: #1f2937; border-left-color: var(--accent); }
        .card { border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .login-card { width: 400px; padding: 40px; border-radius: 16px; }
        #loginOverlay { position: fixed; inset: 0; background: #f3f4f6; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .course-badge { padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .pass-toggle { cursor: pointer; position: absolute; right: 15px; top: 40px; color: #6b7280; }
        .loading-spinner { display: none; position: fixed; top: 20px; right: 20px; z-index: 10001; }
    </style>
</head>
<body>

<div id="loader" class="loading-spinner"><div class="spinner-border text-primary"></div></div>

<div id="loginOverlay">
    <div class="card login-card shadow-lg">
        <div class="text-center mb-4">
            <h2 class="fw-bold text-dark">Ezi<span class="text-primary">nurse</span></h2>
            <p class="text-muted">Desktop Administration Portal</p>
        </div>
        <div class="mb-3">
            <label class="form-label small fw-bold">ADMIN EMAIL</label>
            <input type="email" id="admEmail" class="form-control" placeholder="glory.ezinurse@gmail.com">
        </div>
        <div class="mb-4 position-relative">
            <label class="form-label small fw-bold">PASSWORD</label>
            <input type="password" id="admPass" class="form-control">
            <i class="fas fa-eye pass-toggle" id="togglePass" onclick="togglePasswordVisibility()"></i>
        </div>
        <button onclick="login()" class="btn btn-primary w-100 py-2 fw-bold">Login to Dashboard</button>
    </div>
</div>

<div class="sidebar d-flex flex-column" id="sidebarUI" style="display:none !important;">
    <div class="p-4 mb-4">
        <h4 class="fw-bold m-0 text-white">Ezinurse Panel</h4>
    </div>
    <nav class="nav flex-column">
        <a class="nav-link active" href="#" onclick="showSection('searchSection')"><i class="fas fa-user-edit me-3"></i>User Management</a>
        <a class="nav-link" href="#" onclick="fetchSignups()"><i class="fas fa-users me-3"></i>Recent Signups</a>
        <a class="nav-link" href="#" onclick="fetchExpired()"><i class="fas fa-calendar-times me-3"></i>Expired Courses</a>
        <hr class="mx-3 text-secondary">
        <a class="nav-link text-danger mt-auto" href="#" onclick="location.reload()"><i class="fas fa-sign-out-alt me-3"></i>Logout</a>
    </nav>
</div>

<div class="main" id="mainUI" style="display:none;">
    <div id="searchSection">
        <div class="row mb-5 align-items-center">
            <div class="col-md-6"><h3>User Directory</h3></div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="userQuery" class="form-control" placeholder="Enter student email address...">
                    <button class="btn btn-primary px-4" onclick="findUser()">Search</button>
                </div>
            </div>
        </div>

        <div id="userProfile" style="display:none;">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card h-100 p-4">
                        <div class="d-flex align-items-center mb-4">
                            <div class="bg-primary text-white rounded-circle p-3 me-3"><i class="fas fa-user fa-lg"></i></div>
                            <div>
                                <h5 class="m-0 fw-bold" id="resName"></h5>
                                <small class="text-muted" id="resEmail"></small>
                            </div>
                        </div>
                        <p class="mb-1 fw-bold small">DEVICE ID</p>
                        <p class="text-break bg-light p-2 rounded small" id="resDevice"></p>
                        <div class="mt-4 pt-3 border-top">
                            <button class="btn btn-outline-danger btn-sm w-100 mb-2" onclick="actionBtn('resetDevice')">Reset Device Lock</button>
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="actionBtn('resetPass')">Change Password</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card p-4">
                        <h5 class="fw-bold mb-4">Course Access & Management</h5>
                        <div class="row g-3" id="courseGrid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tableSection" style="display:none;">
        <h3 id="tableTitle" class="mb-4">Recent Data</h3>
        <div class="card p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light text-secondary small uppercase" id="tHead"></thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="expiryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5>Set Course Expiry</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p id="targetCourseName" class="fw-bold text-primary"></p>
                <input type="date" id="expiryDateInput" class="form-control">
            </div>
            <div class="modal-footer"><button class="btn btn-primary w-100" onclick="confirmGrant()">Grant Access</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzVTnrWNR7c2_xkmuLzmJtKeRWSpY2PvFiflMCoYLrNZlixzTFjIdDBiFwtG0eKayrRTg/exec';
    let currentUser = null;
    let pendingCourse = null;
    const expiryModal = new bootstrap.Modal(document.getElementById('expiryModal'));

    function togglePasswordVisibility() {
        const passInput = document.getElementById('admPass');
        const icon = document.getElementById('togglePass');
        if (passInput.type === 'password') {
            passInput.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            passInput.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    async function api(params, method = 'GET', body = null) {
        document.getElementById('loader').style.display = 'block';
        const url = new URL(API_URL);
        Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
        const options = { method };
        if (body) options.body = JSON.stringify(body);
        const res = await fetch(url, options);
        const data = await res.json();
        document.getElementById('loader').style.display = 'none';
        return data;
    }

    async function login() {
        const email = document.getElementById('admEmail').value;
        const pass = document.getElementById('admPass').value;
        const res = await api({ action: 'login', email, password: pass });
        if (res.success) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('sidebarUI').style.setProperty('display', 'flex', 'important');
            document.getElementById('mainUI').style.display = 'block';
        } else alert('Unauthorized');
    }

    async function findUser() {
        const email = document.getElementById('userQuery').value;
        const res = await api({ action: 'getUser', email });
        if (res.error) return alert(res.error);
        currentUser = res.user;
        document.getElementById('resName').innerText = currentUser.Name;
        document.getElementById('resEmail').innerText = currentUser.Email;
        document.getElementById('resDevice').innerText = currentUser.DeviceID || 'Unlinked';
        
        const grid = Object.keys(currentUser).filter(k => k.includes('_') || k === '3d_models').map(key => {
            const hasAccess = currentUser[key] === true;
            return `<div class="col-md-6">
                <div class="course-badge">
                    <span class="small fw-bold">${key.replace(/_/g, ' ').toUpperCase()}</span>
                    <div>
                        ${hasAccess ? 
                            `<button class="btn btn-sm btn-danger px-3" onclick="updateAccess('${key}', false)">Revoke</button>` : 
                            `<button class="btn btn-sm btn-success px-3" onclick="openGrantModal('${key}')">Grant</button>`
                        }
                    </div>
                </div>
            </div>`;
        }).join('');
        
        document.getElementById('courseGrid').innerHTML = grid;
        document.getElementById('userProfile').style.display = 'block';
        showSection('searchSection');
    }

    function openGrantModal(course) {
        pendingCourse = course;
        document.getElementById('targetCourseName').innerText = course.toUpperCase();
        expiryModal.show();
    }

    async function confirmGrant() {
        const date = document.getElementById('expiryDateInput').value;
        if(!date) return alert('Select date');
        await updateAccess(pendingCourse, true, date);
        expiryModal.hide();
    }

    async function updateAccess(course, status, expiry = '') {
        const payload = { email: currentUser.Email, courseKey: course, status: status, expiry: expiry };
        await api({ action: 'updateAccess' }, 'POST', payload);
        findUser();
    }

    async function fetchSignups() {
        const data = await api({ action: 'getRecent' });
        document.getElementById('tableTitle').innerText = 'Recent Signups (Newest First)';
        document.getElementById('tHead').innerHTML = '<tr><th>Name</th><th>Email</th><th>Registration Date</th></tr>';
        document.getElementById('tBody').innerHTML = data.map(r => `<tr><td class="fw-bold">${r.name}</td><td>${r.email}</td><td>${new Date(r.date).toLocaleString()}</td></tr>`).join('');
        showSection('tableSection');
    }

    async function fetchExpired() {
        const data = await api({ action: 'getExpired' });
        document.getElementById('tableTitle').innerText = 'Expired Licenses';
        document.getElementById('tHead').innerHTML = '<tr><th>Email</th><th>Course</th><th>Expiry Date</th></tr>';
        document.getElementById('tBody').innerHTML = data.map(r => `<tr class="table-danger"><td>${r.email}</td><td>${r.course}</td><td>${new Date(r.expiry).toLocaleDateString()}</td></tr>`).join('');
        showSection('tableSection');
    }

    async function actionBtn(type) {
        if(type === 'resetDevice') {
            if(confirm('Clear device hardware lock?')) {
                await api({ action: 'resetDevice', email: currentUser.Email });
                findUser();
            }
        } else {
            const newP = prompt('New password for ' + currentUser.Name);
            if(newP) await api({ action: 'resetPass', email: currentUser.Email, newPass: newP });
        }
    }

    function showSection(id) {
        ['searchSection', 'tableSection'].forEach(s => document.getElementById(s).style.display = (s === id ? 'block' : 'none'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    }
</script>
</body>
</html>
