<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ezinurse Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --sidebar: #0f172a; --primary: #2563eb; }
        body { background: #f1f5f9; font-family: 'Segoe UI', system-ui, sans-serif; }
        .sidebar { width: 280px; height: 100vh; background: var(--sidebar); color: white; position: fixed; }
        .content { margin-left: 280px; padding: 40px; }
        .nav-link { color: #94a3b8; padding: 12px 25px; border-left: 4px solid transparent; cursor: pointer; text-decoration: none; display: block; }
        .nav-link.active { background: #1e293b; color: white; border-left-color: var(--primary); }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .course-card { padding: 15px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; background: white; }
        #loginBox { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .pass-eye { cursor: pointer; position: absolute; right: 15px; top: 38px; color: #64748b; }
        .hidden { display: none !important; }
    </style>
</head>
<body onload="checkSession()">

<div id="loginBox">
    <div class="card p-5 shadow-lg" style="width: 420px;">
        <div class="text-center mb-4">
            <h2 class="fw-bold m-0 text-dark">Ezi<span class="text-primary">nurse</span></h2>
            <p class="text-muted small">Admin Panel Login</p>
        </div>
        <div class="mb-3"><label class="small fw-bold">EMAIL</label><input type="email" id="admE" class="form-control" placeholder="Admin Email"></div>
        <div class="mb-4 position-relative"><label class="small fw-bold">PASSWORD</label><input type="password" id="admP" class="form-control"><i class="fas fa-eye pass-eye" onclick="toggleP()"></i></div>
        <button onclick="doLogin()" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">Sign In</button>
    </div>
</div>

<div id="mainDashboard" class="hidden">
    <div class="sidebar d-flex flex-column">
        <div class="p-4 border-bottom border-secondary mb-3"><h4 class="fw-bold m-0 text-white">Ezi Nurse Admin Panel</h4></div>
        <nav class="nav flex-column">
            <a class="nav-link active" id="nav-search" onclick="showSection('searchS')"><i class="fas fa-search me-3"></i>User Management</a>
            <a class="nav-link" id="nav-analytics" onclick="loadAnalytics()"><i class="fas fa-chart-bar me-3"></i>Course Analytics</a>
            <a class="nav-link" id="nav-signups" onclick="loadSignups()"><i class="fas fa-users me-3"></i>Recent Signups</a>
            <a class="nav-link" id="nav-expired" onclick="loadExpired()"><i class="fas fa-user-clock me-3"></i>Expired Access</a>
            <a class="nav-link text-danger mt-auto" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-3"></i>Logout</a>
        </nav>
    </div>

    <div class="content">
        <div id="searchS">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <h3>User Directory</h3>
                <div class="d-flex w-50 shadow-sm"><input type="text" id="q" class="form-control me-2" placeholder="Search user email..."><button class="btn btn-primary px-4" onclick="search()">Search</button></div>
            </div>
            <div id="profile" style="display:none;">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card p-4 h-100 shadow-sm border-top border-primary border-4">
                            <h5 id="pName" class="fw-bold mb-1"></h5>
                            <p id="pEmail" class="text-muted small mb-4"></p>
                            <div class="bg-light p-3 rounded mb-4">
                                <p class="small mb-2"><b>Registered:</b> <span id="pReg" class="float-end"></span></p>
                                <p class="small mb-2"><b>Last Login:</b> <span id="pLog" class="float-end"></span></p>
                                <p class="small mb-0"><b>Device ID:</b> <span id="pDev" class="text-truncate d-inline-block" style="max-width: 100px;"></span></p>
                            </div>
                            <button class="btn btn-outline-danger btn-sm w-100 mb-2" onclick="resetD()">Reset Device Lock</button>
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="resetP()">Change Password</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card p-4 shadow-sm">
                            <h5 class="fw-bold mb-4">Manage Course Access</h5>
                            <div class="row g-2" id="cGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tableS" style="display:none;">
            <h3 id="tTitle" class="mb-4 text-dark fw-bold">Data Management</h3>
            <div class="card p-0 shadow-sm overflow-hidden"><table class="table table-hover align-middle mb-0"><thead class="table-light py-3" id="tH"></thead><tbody id="tB"></tbody></table></div>
        </div>
    </div>
</div>

<div class="modal fade" id="expM" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header"><h5 class="fw-bold">Set Course Expiry</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><label class="small fw-bold mb-2">PICK DATE</label><input type="date" id="expD" class="form-control"></div>
            <div class="modal-footer"><button class="btn btn-primary w-100 py-2" onclick="saveAccess()">Grant/Update Access</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = 'https://script.google.com/macros/s/AKfycbzNDwLb_ocX7t183vh9XrqowByFqFHRrUDi6wUFDtHjXN3hWbrk7xd0GCzM7SL-OfLROA/exec';
    let currUser = null, currCourse = null;
    const expM = new bootstrap.Modal(document.getElementById('expM'));

    function toggleP() { const p = document.getElementById('admP'); p.type = p.type === 'password' ? 'text' : 'password'; }

    // Session logic
    function checkSession() {
        const session = localStorage.getItem('ezi_admin_session');
        if (session === 'active') {
            document.getElementById('loginBox').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
        }
    }

    async function call(p, m='GET', b=null) {
        const u = new URL(API); Object.keys(p).forEach(k => u.searchParams.append(k, p[k]));
        const r = await fetch(u, { method: m, body: b ? JSON.stringify(b) : null });
        return r.json();
    }

    async function doLogin() {
        const res = await call({ action: 'login', email: document.getElementById('admE').value, password: document.getElementById('admP').value });
        if(res.success) {
            localStorage.setItem('ezi_admin_session', 'active');
            document.getElementById('loginBox').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
        } else alert('Access Denied');
    }

    function logout() {
        localStorage.removeItem('ezi_admin_session');
        location.reload();
    }

    async function search() {
        const res = await call({ action: 'getUser', email: document.getElementById('q').value });
        if(res.error) return alert(res.error);
        currUser = res.user;
        document.getElementById('pName').innerText = currUser.Name;
        document.getElementById('pEmail').innerText = currUser.Email;
        document.getElementById('pReg').innerText = new Date(currUser['Registration Date']).toLocaleDateString();
        document.getElementById('pLog').innerText = currUser['Last Login'] ? new Date(currUser['Last Login']).toLocaleString() : 'Never';
        document.getElementById('pDev').innerText = currUser.DeviceID || 'No Link';
        
        const grid = Object.keys(currUser).filter(k => k.includes('_') || k === '3d_models').map(k => {
            const active = currUser[k] === true || currUser[k] === "true";
            const exp = res.expiries[k] ? new Date(res.expiries[k]).toLocaleDateString() : 'No Data';
            return `<div class="col-md-6"><div class="course-card ${active ? 'border-primary' : ''}">
                <div class="d-flex justify-content-between align-items-center">
                    <div><span class="small fw-bold text-uppercase d-block">${k.replace(/_/g,' ')}</span>
                    <small class="text-muted">${active ? 'Expires: '+exp : 'Inactive'}</small></div>
                    <div class="d-flex">
                        ${active ? `<button class="btn btn-sm btn-outline-primary me-1" onclick="openExp('${k}')" title="Change Expiry"><i class="fas fa-calendar"></i></button>
                                   <button class="btn btn-sm btn-outline-danger" onclick="update('${k}', false)" title="Revoke Access"><i class="fas fa-user-slash"></i></button>` : 
                        `<button class="btn btn-sm btn-success px-3 fw-bold" onclick="openExp('${k}')">Grant</button>`}
                    </div>
                </div>
            </div></div>`;
        }).join('');
        document.getElementById('cGrid').innerHTML = grid;
        document.getElementById('profile').style.display = 'block';
    }

    function openExp(c) { currCourse = c; expM.show(); }
    async function saveAccess() { await update(currCourse, true, document.getElementById('expD').value); expM.hide(); }

    async function update(c, s, e='') {
        await call({ action: 'updateAccess' }, 'POST', { email: currUser.Email, courseKey: c, status: s, expiry: e });
        search();
    }

    async function loadAnalytics() {
        const res = await call({ action: 'getAnalytics' });
        document.getElementById('tTitle').innerText = 'Student Distribution (All Time)';
        document.getElementById('tH').innerHTML = '<tr><th class="ps-4">COURSE MODULE</th><th>TOTAL ACTIVE STUDENTS</th></tr>';
        document.getElementById('tB').innerHTML = Object.keys(res).map(k => `<tr><td class="ps-4 fw-bold text-uppercase">${k.replace(/_/g,' ')}</td><td><span class="badge rounded-pill bg-primary px-3">${res[k]} Students</span></td></tr>`).join('');
        showSection('tableS', 'nav-analytics');
    }

    async function loadSignups() {
        const res = await call({ action: 'getRecent' });
        document.getElementById('tTitle').innerText = 'Recent Registration Feed';
        document.getElementById('tH').innerHTML = '<tr><th class="ps-4">NAME</th><th>EMAIL</th><th>REGISTERED</th><th>LAST LOGIN</th></tr>';
        document.getElementById('tB').innerHTML = res.map(r => `<tr><td class="ps-4 fw-bold">${r.name}</td><td>${r.email}</td><td>${new Date(r.date).toLocaleDateString()}</td><td>${r.lastLogin ? new Date(r.lastLogin).toLocaleString() : 'Never'}</td></tr>`).join('');
        showSection('tableS', 'nav-signups');
    }

    async function loadExpired() {
        const res = await call({ action: 'getExpired' });
        document.getElementById('tTitle').innerText = 'System Alerts: Expired Users';
        document.getElementById('tH').innerHTML = '<tr><th class="ps-4">USER EMAIL</th><th>COURSE</th><th>EXPIRED ON</th></tr>';
        document.getElementById('tB').innerHTML = res.map(r => `<tr class="table-danger border-white"><td class="ps-4 fw-bold">${r.email}</td><td>${r.course.toUpperCase()}</td><td>${new Date(r.expiry).toLocaleDateString()}</td></tr>`).join('');
        showSection('tableS', 'nav-expired');
    }

    async function resetD() { if(confirm('Erase Hardware ID?')) { await call({ action: 'resetDevice', email: currUser.Email }); search(); } }
    async function resetP() { const p = prompt('Set New Password:'); if(p) { await call({ action: 'resetPass', email: currUser.Email, newPass: p }); search(); } }

    function showSection(s, navId) { 
        document.getElementById('searchS').style.display = s === 'searchS' ? 'block' : 'none';
        document.getElementById('tableS').style.display = s === 'tableS' ? 'block' : 'none';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if(navId) document.getElementById(navId).classList.add('active');
        else document.getElementById('nav-search').classList.add('active');
    }
</script>
</body>
</html>
